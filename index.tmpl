<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Playlister</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Playlister</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <h2>Song parameters</h2>
          <table>
            <tr><td><input type="checkbox" id="acousticness_toggle"><label for="acousticness">Acousticness</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="acousticness" step="1" oninput="outputUpdate('acousticness_value', value)">
            <td><output for="acousticness" id="acousticness_value">0.5</output>

            <tr><td><input type="checkbox" id="danceability_toggle"><label for="danceability">Danceability</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="danceability" step="1" oninput="outputUpdate('danceability_value', value)">
            <td><output for="danceability" id="danceability_value">0.5</output>

            <tr><td><input type="checkbox" id="energy_toggle"><label for="energy">Energy</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="energy" step="1" oninput="outputUpdate('energy_value', value)">
            <td><output for="energy" id="energy_value">0.5</output>

            <tr><td><input type="checkbox" id="instrumentalness_toggle"><label for="instrumentalness">Instrumentalness</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="instrumentalness" step="1" oninput="outputUpdate('instrumentalness_value', value)">
            <td><output for="instrumentalness" id="instrumentalness_value">0.5</output>

            <tr><td><input type="checkbox" id="liveness_toggle"><label for="liveness">Liveness</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="liveness" step="1" oninput="outputUpdate('liveness_value', value)">
            <td><output for="liveness" id="liveness_value">0.5</output>

            <tr><td><input type="checkbox" id="loudness_toggle"><label for="loudness">Loudness</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="loudness" step="1" oninput="outputUpdate('loudness_value', value)">
            <td><output for="loudness" id="loudness_value">0.5</output>

            <tr><td><input type="checkbox" id="mode_toggle"><label for="mode">Mode</label><td>
            <input type="radio" name="mode" value="1" checked> Major
            <input type="radio" name="mode" value="0"> Minor<br>

            <tr><td><input type="checkbox" id="popularity_toggle"><label for="popularity">Popularity</label><td>
            <input type="range" min="0" max="100" value="50" step="1" id="popularity" step="1" oninput="outputUpdate('popularity_value', value)">
            <td><output for="popularity" id="popularity_value">50</output>

            <tr><td><input type="checkbox" id="speechiness_toggle"><label for="speechiness">Speechiness</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="speechiness" step="1" oninput="outputUpdate('speechiness_value', value)">
            <td><output for="speechiness" id="speechiness_value">0.5</output>

            <tr><td><input type="checkbox" id="valence_toggle"><label for="valence">Valence</label><td>
            <input type="range" min="0" max="1" value=".5" step="0.01" id="valence" step="1" oninput="outputUpdate('valence_value', value)">
            <td><output for="valence" id="valence_value">0.5</output>
          </table>
          <button onclick="getRecs()">GET RECS</button>
        </div>
        <div class="col-sm-6">
          <div class="row">
            <div class="col-sm-12">
              <h2>Artist seeds</h2>
              <div id="seedartistsdisplay"></div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <h3>Add an artist</h3>
              <div>
                <form action="javascript:artistSearch();">
                  <input type="text" id="artistsearch"><br>
                  <input type="submit" value="Search"><br><br>
                </form>
              </div>
              <div id="artistoptions"></div>
            </div>
          </div>

        </div>
      </div>

    <div>

    </div>
    <hr>

    <div>
      <h2>Results</h2>
      <a href="https://accounts.spotify.com/authorize?client_id={{ .client_id }}&redirect_uri=http:%2F%2Flocalhost:8080&response_type=token&scope=playlist-modify-private">GOOOO</a>
      <div id="tracks"></div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>

<script>

var seedartists = [];

function outputUpdate(id, val) {
	document.querySelector('#' + id).value = val;
}

// get options for seed artists based on a typed name:
function artistSearch() {
  $.get( "/search", {"artist_name": $("#artistsearch").val()})
  .done(function( data ) {
    results = "";
    for(var i=0, band; band=data[i]; i++){
      results += "<button onclick=\"addArtist('" + band.name + "', '" + band.id + "')\">" + band.name + "</button><br>";
    }
    if(data.length == 0) results = "Sorry, no artists found.";
    $("#artistoptions").html(results);
  })
  .fail(function(err) {
    console.log("SOMETHING BROKE");
    console.log(err);
  });
}

// print the seed artists
function updateSeedArtists() {
  results = "<ul>";
  for(var i=0, band; band=seedartists[i]; i++){
    results += "<li><button onclick=\"removeArtist('" + band.id + "')\">remove</button>" + band.name;
  }
  results += "</ul>";
  $("#seedartistsdisplay").html(results);
}
// add an artist to the list of seeds
function addArtist(name, id) {
  console.log(name + " AAA " + id);
  seedartists.push({"name": name, "id": id});
  updateSeedArtists();
}

// remove an artist from the list of seeds
function removeArtist(id) {
  for(var i=0, band; band=seedartists[i]; i++){
    if(band.id == id) {
      seedartists.splice(i, 1);
      break;
    }
  }
  updateSeedArtists();
}

// send the seed artist, get the recs:
function getRecs() {
  console.log(seedartists);

  artistIDs = "";
  for(var i=0, band; band=seedartists[i]; i++){
    console.log("YERP: " + band.id);
    artistIDs += band.id;
    if(i+1 != seedartists.length) artistIDs += ",";
  }
  params = getKnobValues();
  params.artist_id = artistIDs;
  $.get("/recs", params).done(printRecs);
}

function getKnobValues() {
  values = {};
  categories = [
    "acousticness",
    "danceability",
    "energy",
    "instrumentalness",
    "liveness",
    "loudness",
    //"mode",
    "popularity",
    "speechiness",
    "valence",
  ];
  for(var i=0, cat; cat=categories[i]; i++) {
    if($("#" + cat + "_toggle").is(':checked')) {
      values[cat] = document.querySelector('#' + cat).value;
    }
  }
  // the "Mode" value is handled differently:
  if($("#mode_toggle").is(':checked')) {
    values["mode"] = $('input[name=mode]:checked').val();
  }
  return values;
}

// display recommendations
function printRecs(data) {
  results = "<ul>"
  for(var i=0, rec; rec=data[i]; i++){
      results += "<li>" + rec.artists[0].name + ", \"" + rec.name + "\""
  }
  if(data.length == 0) results="Sorry, no tracks found.";
  $("#tracks").html(results);
}


</script>
  </body>
</html>
